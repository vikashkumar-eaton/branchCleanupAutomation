name: Update PR Title with JIRA ID

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  update-pr-title:
    runs-on: windows-latest
    steps:
      - name: Extract JIRA ID from branch
        id: extract_jira
        shell: pwsh
        run: |
          $branchName = "${{ github.head_ref }}"
          if ($branchName -match '([A-Za-z]+-[0-9]+)') {
            $jiraId = $Matches[1].ToUpper()
            echo "JIRA_ID=$jiraId" >> $env:GITHUB_ENV
          } else {
            echo "JIRA_ID=" >> $env:GITHUB_ENV
          }

      - name: Update PR Title via API
        if: env.JIRA_ID != ''
        shell: pwsh
        run: |
          $currentTitle = "${{ github.event.pull_request.title }}"
          $jiraId = "${{ env.JIRA_ID }}"
          # Remove any existing JIRA ID at the start
          $newTitle = $currentTitle -replace '^[A-Za-z]+-[0-9]+\s*:\s*', ''
          $newTitle = "$jiraId : $newTitle".Trim()
          $prNumber = ${{ github.event.pull_request.number }}
          $repo = "${{ github.repository }}"
          $token = "${{ secrets.PERSONAL_GITHUB_TOKEN }}"

          $headers = @{
            Authorization = "Bearer $token"
            Accept        = "application/vnd.github+json"
          }

          $body = @{ title = $newTitle } | ConvertTo-Json

          Invoke-RestMethod -Uri "https://api.github.com/repos/$repo/pulls/$prNumber" `
                            -Method PATCH `
                            -Headers $headers `
                            -Body $body
